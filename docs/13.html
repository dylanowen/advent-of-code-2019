<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Advent Of Code 2019</title>
    <style type="text/css"><!--
    .hidden {
        visibility: hidden;
    }

    --></style>
    <script src="js/utils.js"></script>
</head>
<canvas id="screen"></canvas><br />
Score: <span id="score"></span><br />
<input type="button" value="Restart" id="restart"/>
<input type="button" value="My Winning Game" id="auto"/>
<script>
    LibReady('advent_of_code_2019')
        .then((lib) => {
            const canvas = document.getElementById('screen');
            const scoreField = document.getElementById('score');
            const restartButton = document.getElementById('restart');
            const autoPlayButton = document.getElementById('auto');
            let isAutoPlay = false;

            autoPlayButton.addEventListener('click', () => {
                isAutoPlay = !isAutoPlay;
                startGame();
            });

            let game = null;
            let state;

            function startGame() {
                if (game != null) {
                    game.free();
                }

                game = new lib.ThirteenGame(canvas, isAutoPlay);
                state = lib.ExecutionState.Running;

                step(1);
            }

            function step(input) {
                state = game.step(input);
                game.render_game();
                scoreField.textContent = game.score();
            }

            startGame();

            function keyEvent(event) {
                if (event.isComposing || event.keyCode === 229) {
                    return;
                }
                let input = 0;
                if (event.key === 'a') {
                    input = -1;
                }
                else if (event.key === 'd') {
                    input = 1;
                }

                if (state !== lib.ExecutionState.Halted) {
                    step(input);
                }
                else {
                    startGame();
                }
            }

            function autoPlayIterate() {
                if (isAutoPlay) {
                    step(0)
                }
            }

            setInterval(autoPlayIterate, 10);

            window.addEventListener("keydown", keyEvent);

            restartButton.addEventListener('click', () => {
                startGame();
            })



            // canvas.width = game.width() * pixelSize;
            // canvas.height = game.height() * pixelSize;
            //
            // const ctx = canvas.getContext('2d');
            //
            // // pixels are stored in RGBA
            // imgByteSize = canvas.width * canvas.height * 4;
            // imgPointer = lib.alloc_vec(imgByteSize);
            // function step() {
            //     game.step(0);
            //     game.render_game();
            // }
            //
            // step();

            //setInterval(step, 1000);

        })
        //.then(archizoom => archizoom[0].free())
        .catch((e) => console.error(e));


</script>

</body>
</html>